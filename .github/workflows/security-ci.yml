# .github/workflows/build.yml
name: Build Docker Image

on:
  push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        id: docker_build
        run: |
          IMAGE_NAME="inventory-app:${{ github.sha }}"
          echo "Building image: $IMAGE_NAME"
          docker build -t "$IMAGE_NAME" .
          echo "DOCKER_IMAGE=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Save Docker image
        run: docker save "$DOCKER_IMAGE" -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  sast_review:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- Escaneo con Bandit (SAST para Python) ---
      - name: Run Bandit Scan
        uses: docker://python:3.10
        with:
          args: sh -c "pip install bandit && mkdir -p ./reports/bandit && bandit -r . -f json -o ./reports/bandit/report.json || true && bandit -r . -f html -o ./reports/bandit/report.html || true"
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: ./reports/bandit/
          retention-days: 7

      # --- Escaneo con Semgrep (SAST General) ---
      - name: Run Semgrep Scan
        uses: docker://returntocorp/semgrep
        with:
          args: --config auto . --json --output ./reports/semgrep/report.json
        continue-on-error: true
      
      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: ./reports/semgrep/
          retention-days: 7

  sca_review:
    needs: sast_review
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load --input image.tar

      # --- Escaneo con Snyk (SCA) y Trivy (EscÃ¡ner de Contenedor) ---
      - name: Run Snyk and Trivy Scans
        uses: docker://node:18-alpine
        with:
          args: sh -c "apk add --no-cache python3 py3-pip python3-dev git && npm install -g snyk snyk-to-html && python3 -m venv venv && source venv/bin/activate && pip install flit && flit install --deps production && pip freeze > requirements.txt && snyk test --file=requirements.txt --package-manager=pip --json > snyk_results.json || true && snyk test --file=requirements.txt --package-manager=pip || true && snyk-to-html -i snyk_results.json -o snyk_results.html || true && curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin && /usr/local/bin/trivy image --format json --output trivy_results.json inventory-app:${{ github.sha }} || true"
        continue-on-error: true

      - name: Upload Snyk and Trivy Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            snyk_results.json
            snyk_results.html
            trivy_results.json
          retention-days: 7